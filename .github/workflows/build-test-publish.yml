name: Build/Test/Publish

# Controls when the action will run.
on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

defaults:
  run:
    shell: powershell

jobs:
  build-test-publish:
    runs-on: windows-latest

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          lfs: true

      - name: Set up .NET SDK
        uses: actions/setup-dotnet@v1
        with:
          # 3.1.x incorrectly handles references to executables so Geisha.Cli.IntegrationTests fail. 3.1.x is required becase Geisha is not yet migrated to .NET 5 (https://github.com/dawidkomorowski/geisha/issues/265).
          # Use multiple versions as a workaround for https://github.com/dotnet/sdk/issues/1675.
          dotnet-version: |
            3.1.x
            5.0.x

      - name: Clear NuGet cache (workaround for https://github.com/actions/setup-dotnet/issues/155)
        run: dotnet nuget locals all --clear

      - name: Build solution
        run: dotnet build Geisha.sln --configuration Debug

      - name: Install Scream virtual audio device
        run: |
          Start-Service audio*
          Invoke-WebRequest https://github.com/duncanthrax/scream/releases/download/3.6/Scream3.6.zip -OutFile C:\Scream3.6.zip
          Extract-7Zip -Path C:\Scream3.6.zip -DestinationPath C:\Scream
          $cert = (Get-AuthenticodeSignature C:\Scream\Install\driver\Scream.sys).SignerCertificate
          $store = [System.Security.Cryptography.X509Certificates.X509Store]::new("TrustedPublisher", "LocalMachine")
          $store.Open("ReadWrite")
          $store.Add($cert)
          $store.Close()
          cd C:\Scream\Install\driver
          C:\Scream\Install\helpers\devcon install Scream.inf *Scream
          Get-CimInstance Win32_SoundDevice | fl * # Print audio device info.

      - name: Execute tests
        run: dotnet test Geisha.sln --configuration Debug --no-build --logger "trx;LogFileName=test-results.trx"

      - name: Publish test results
        uses: dorny/test-reporter@v1
        if: success() || failure()
        with:
          name: Test Results
          path: test/**/test-results.trx
          reporter: dotnet-trx

      - name: Publish NuGet packages
        run: |
          $projectVersion = Get-Content -Path "project.version" -Raw
          $versionToSet = "$projectVersion+$env:GITHUB_RUN_NUMBER"
          $fileVersionToSet = "$projectVersion.$env:GITHUB_RUN_NUMBER"
          dotnet publish Geisha.sln --configuration Release -p:Version=$versionToSet -p:FileVersion=$fileVersionToSet

      - name: Prepare SDK package
        run: .\scripts\workflow\prepare-sdk-package.ps1 $env:GITHUB_RUN_NUMBER

      - name: Upload SDK package as artifact
        uses: actions/upload-artifact@v2.2.2
        with:
          name: sdk-package
          path: GeishaSDK*.zip

  benchmark-preformance:
    runs-on: windows-latest

    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          lfs: true

      - name: Set up .NET SDK
        uses: actions/setup-dotnet@v1
        with:
          # 3.1.x incorrectly handles references to executables so Geisha.Cli.IntegrationTests fail. 3.1.x is required becase Geisha is not yet migrated to .NET 5 (https://github.com/dawidkomorowski/geisha/issues/265).
          # Use multiple versions as a workaround for https://github.com/dotnet/sdk/issues/1675.
          dotnet-version: |
            3.1.x
            5.0.x

      - name: Clear NuGet cache (workaround for https://github.com/actions/setup-dotnet/issues/155)
        run: dotnet nuget locals all --clear

      - name: Build solution
        run: dotnet build Geisha.sln --configuration Release

      - name: Install Scream virtual audio device
        run: |
          Start-Service audio*
          Invoke-WebRequest https://github.com/duncanthrax/scream/releases/download/3.6/Scream3.6.zip -OutFile C:\Scream3.6.zip
          Extract-7Zip -Path C:\Scream3.6.zip -DestinationPath C:\Scream
          $cert = (Get-AuthenticodeSignature C:\Scream\Install\driver\Scream.sys).SignerCertificate
          $store = [System.Security.Cryptography.X509Certificates.X509Store]::new("TrustedPublisher", "LocalMachine")
          $store.Open("ReadWrite")
          $store.Add($cert)
          $store.Close()
          cd C:\Scream\Install\driver
          C:\Scream\Install\helpers\devcon install Scream.inf *Scream
          Get-CimInstance Win32_SoundDevice | fl * # Print audio device info.

      - name: Execute performance benchmarks
        id: execute-performance-benchmarks
        timeout-minutes: 10
        run: |
          cd benchmark\Benchmark\bin\Release\netcoreapp3.1\
          .\Benchmark.exe | Out-Default

      - name: Print engine log if benchmark fails
        if: failure() && steps.execute-performance-benchmarks.outcome == 'failure'
        run: Write-Host (Get-Content .\benchmark\Benchmark\bin\Release\netcoreapp3.1\GeishaEngine.log -Raw)

      - name: Copy benchmark results to benchmark-results directory
        run: |
          New-Item -ItemType Directory -Path "benchmark-results\$env:GITHUB_RUN_NUMBER\"
          Copy-Item -Path "benchmark\Benchmark\bin\Release\netcoreapp3.1\BenchmarkResults--*" -Destination "benchmark-results\$env:GITHUB_RUN_NUMBER\"

      - name: Donwload benchmark results from previous build
        uses: dawidd6/action-download-artifact@v2
        with:
          workflow: Build/Test/Publish
          workflow_conclusion: success
          name: benchmark-results

      - name: Upload benchmark results as artifact
        uses: actions/upload-artifact@v2.2.2
        with:
          name: benchmark-results
          path: benchmark-results\*

      - name: Publish benchmark results
        run: |
          $prSha = "${{github.event.pull_request.head.sha}}"
          $commitSha = "${{ github.sha }}"
          if ($prSha) { $headSha = $prSha } else { $headSha = $commitSha }
          .\scripts\workflow\publish-benchmark-results.ps1 $headSha ${{ secrets.GITHUB_TOKEN }}
